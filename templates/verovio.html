
{% extends "layout.html" %}
{% import "bootstrap/wtf.html" as wtf %}

{% block title %}
Verovio
{% endblock %}

{% block styles %}
{{super()}}
<link rel="stylesheet" href="{{url_for('.static', filename='signup.css')}}">

{% endblock %}
{% block content %}

<div class="panel-body">
    <div><button><a id="download" href="{{url_for('.static', filename=filename)}}">Download "{{ filename  }}"</a></button></div>
    <!-- <div><button id="show-notes">Show notes</button></div>
    <div id="app" class="panel" style="border: 1px solid lightgray; min-height: 800px; visibility:hidden;"></div> -->
    <main>
      <div class="controls">
        <button id="btn-play">Play</button>
        <button id="btn-pause">Pause</button>
        <button id="btn-stop">Stop</button>
      </div>
      <div>
        <h2 id="loading">Loading</h2>
      </div>
      <div id="score"></div>
    </main>
</div>

<script type="module">
    import 'https://www.verovio.org/javascript/app/verovio-app.js';

    const musicXml = `{{ music_xml | safe }}`
    
    function setVerovio(){
      // Create the app - here with an empty option object
      const verovioApp =document.getElementById("app")
      const app = new Verovio.App(verovioApp, {});
  
      const fileName = '{{ filename }}'
      console.log(musicXml)
      
      const showNotesButton = document.getElementById('show-notes');
      showNotesButton.addEventListener('click',()=>{
        if(verovioApp.style.visibility == 'hidden'){
          verovioApp.style.visibility = 'visible';
        } else {
          verovioApp.style.visibility = 'hidden';
        }
      })
  
      app.loadData(musicXml)

    }



  /////////////
  const osmd = new opensheetmusicdisplay.OpenSheetMusicDisplay(document.getElementById("score"));
  const audioPlayer = new OsmdAudioPlayer();

  const scoreXml = musicXml;
  await osmd.load(scoreXml);
  await osmd.render();
  //await audioPlayer.loadScore(osmd);
  audioPlayer.on("iteration", notes => {
    console.log(notes);
  });

  hideLoadingMessage();
  registerButtonEvents(audioPlayer);

  function hideLoadingMessage() {
    document.getElementById("loading").style.display = "none";
  }

  function registerButtonEvents(audioPlayer) {
    document.getElementById("btn-play").addEventListener("click", () => {
      if (audioPlayer.state === "STOPPED" || audioPlayer.state === "PAUSED") {
        audioPlayer.play();
      }
    });
    document.getElementById("btn-pause").addEventListener("click", () => {
      if (audioPlayer.state === "PLAYING") {
        audioPlayer.pause();
      }
    });
    document.getElementById("btn-stop").addEventListener("click", () => {
      if (audioPlayer.state === "PLAYING" || audioPlayer.state === "PAUSED") {
        audioPlayer.stop();
      }
    });
  }
    </script> 
{% endblock %}